# mirror
mirror

OVERVIEW
MIRROR mirrors slack channels.

TODO NEXT
---------
* BUG @mirror mirror silenced channel = mirroring undefined -> ripcitysoftware#mirror-debug but it works(!)

* TODO MIRROR NOT DELETING BOTS AND DB STUFF!!!
* TODO UNSUBSCRIBE FROM THE PUBLISH SIDE OF UNSUBSCRIBED LINKS - RIGHT NOW THEY SEND NOWHERE
* TODO UNIQUE NAMES FOR FILE DOWNLOADS - RIGHT NOW JUST USING WHAT'S GIVEN

* DONE BOT GOES DEAF AFTER X TIME - NEEDS TO BE RESTARTED - ADDED HEARTBEAT - WORKED FOR A WEEK 
* DONE BOT PRINTS DUMB ERROR IF @name IS USED TO JOIN A CHANNEL 
* DONE MIRROR HAVING ISSUES WITH LOCKED CHANNELS (undefined) - FIXED
* DONE UNMIRROR EVERYTHING WHEN BOT IS UNINSTALLED (UGH)
* DONE ADD CHANNEL NAMES WHERE APPROPRIATE (LOCAL SIDE ONLY - DOESN'T MAKE SENSE REALLY)
* DONE FIX UNMIRROR /maclawran.slack.com/messages/CFMMBM5AP (NON HTTP)
* DONE SEND A MIRRORING MESSAGE TO THE OTHER SIDE OF A CONNECTION (NO MSG FOR UNMIRRORING)
* DONE WE UNSUBSCRIBE FOR EVERYTHING WHEN WE UNMIRROR - UNSUBSCRIBE WHEN NOBODY LEFT LISTENING
* DONE CHECK HOW OTHER APPS ONBOARD (LOOK AND FEEL) - WE'RE FINE
* DONE UNMIRROR WHEN KICKED FROM A CHANNEL
* DONE FIX UNMIRROR /maclawran.slack.com/messages/CFMMBM5AP (NON HTTP)

TODO EVENTUALLY
---------------
* TODO SUPPORT DELETE UPLOADED FILES (DEL AFTER 24h)
* TODO SHOW AUTHOR ON ATTACHMENTS (BREAKS EMBEDDED JSON)

* DONE RATIONALIZE LINK STUFF - LINKS IN THE DB NOW
* DONE STORE LINKS IN MONGO VS IN A FILE (scaling by sharding)
* DONE SAVE LINKS IN MONGO INSTEAD OF ON-DISK (SEE LINKS DISCUSSION)
* DONE DELETE LINKS WHEN CLIENT IS DELETED OR DO WE LEAVE THEM (EASY CLIENT REINSTALL)

LINKS AND SHARDING
------------------
* WE PUBLISH TO LOCAL LINKS AND SUBSCRIBE TO THE REMOTE LINKS
  SO STARTUP IS SIMPLE, JUST SUBSCRIBE TO ALL REMOTE LINKS
* RIGHT NOW IT'S A BIG WHACK OF LINKS KEPT IN ONE ARRAY CALLED links
* FOR SHARDING, SPLIT UP THE CLIENTS AND THEIR LISTENING LINKS (LOCAL)
  SO EACH bot COULD LISTEN TO N CLIENTS, SLACK JUST SEES A BOT REQUEST
  FROM 'SOMEWHERE'... SO ADD THE IDEA OF A BOTHOST OF SOME KIND
  BOTHOSTS => CLIENTS => LINKS IS THE STRUCTURE WE NEED
* CLIENTS NEED A BOTHOST
* LINKS NEED A CLIENT (LISTENERS)
* ONLY TIME IT'S AN ISSUE IS WHEN WE'RE DELETING LINKS
    DELETE IS SLOW BUT SHOULDN'T BE IF FILTER IS WORKING, JUST
    FILTER OUT THE GROUP TO DELETE AND RE-SAVE - NEED FILTER WITH MULTIPLE ELEMENTS
* KICKING THE BOT OUT OF A CHANNEL SHOULD DELETE ALL SUBSCRIPTIONS AND LINKS TO THE CHANNEL
* WE NEED TO FIND THE BOT ASSOCIATED WITH A GIVEN GROUP/DOMAIN
    RIGHT NOW THAT'S A MANUAL SEARCH ON EVERY MESSAGE
    there should be a datastrcuture like
    bots [
        {
        domain,
        bot
        }
    ]
    so we could say bot=domain['maclawran'];
    * SEE HOW TO SET THIS UP


TODO: NEW COMMANDS
* add archive COMMAND TO ARCHIVE CHANNELS (SLACK HAS THIS AND THERE ARE TOOLS TO READ)
* add "monitor" or "listen" command to see messages from a remote channel only

* DONE: BASIC SANITY CHECKS FOR MIRRORED LINKS (*YOU CAN PUT ANYTHING IN THERE)
* DONE NEED TO REMOVE LINKS CORRECTLY ON UNLINK
* DONE SUPPORT ATTACHEMENTS (LIKE GIPHY)
* DONE SOMEHOW PUT NAME ON UPLOADED FILES (NOT JUST BOT)
* DONE FILE SHARING
* DONE FILE DOWNLOAD DONE
* DONE FILE UPLOAD SHOULD BE SIMPLE, THEN SHARE FILE
* DONE embed a nice avatar (how) FOR THE MIRROR USER
* DONE MAKE DOMAIN AND/OR TEAM UNIQUE IN MONGO
* DONE save new clients in DB locally 
* DONE implement /cmd channel to add/del new clients
* DONE need to figure out their domain (team.info command?)
* DONE implement slack oauth2
* DONE store and retreive client records in mongo
* DONE restart bot every 24h from cron for now (lets see if this works)
* DONE need small commandline program to send message directly to an MQTT channel for testing
* DONE store tokens and team names in mongodb
* DONE change command from nsa: to @nsa to @mirror
* DONE SUCCESS OR FAIL MESSAGE AFTER ATTEMPTING TO INSTALL (WE JUST REDIRECT NOW)

FIXED BUGS
----------
* FIXED FIND BOT BY CHANNEL undefined WITH oeacademics - subscribe closer to db read
* FIXED *unlink* command is only unlinking the local half the connection
* SEARCH FOR NON-EXISTANT BOT AFTER REINSTALL (EVERYTHING WORKS THOUGH)
* FIXED APP CAN BE ADDED MULTIPLE TIMES TO SAME SITE
* FIXED FILE XFER LOOPS - KEEPS SENDING THE FILE OVER AND OVER - CAN'T ID BOT USER
* FIXED BUG WITH @mirror status in #boatsarch - NO IDEA WHY - MAYBE BECUASE IT'S LOCKED

MQTT USES TOPICS TO DENOTE CHANNELS - 
    * /maclawran.slack.com/messages/D2Z6F6X4H
    * /ctrl/add|delete - ADD OR DELETE CLIENTS IN REAL TIME
        HAS EXTRA BENEFIT OF BEING FAULT-TOLERANT IF CLIENT IS DOWN
    * /ctrl/archive/add|del - TELLS THE ARCHIVING PROGRAM TO SUBSCRIBE TO A CHANNEL TO ARCHIVE IT

FOR ARCHIVING HAVE THE CLIENT SUBSCRIBE TO THE CHANNEL WE
WANT ARCHIVED - QUESTION IS HOW TO SEND THEM THAT MESSAGE?
    * THE PROGRAM SUBSCRIBES TO /ctrl/archive TO GET CONTROL MESSAGES
        * THE MESSAGE IS THE CHANNEL TO SUBSCRIBE TO

FOR CONTROL - mirror-bot.js SUBSCRIBES TO /ctrl/manage
    * /ctrl/add - TELLS bot TO ADD THE CLIENT IN THE message
    * /ctrl/del - TELLS bot TO DELETE THE CLIENT IN THE message
    * /ctrl/cmd - GET CLIENTS, GET LINKS (links aren't saved by client now - they should be to scale)

ON STARTUP - HOW DO WE START THE LISTENERS?
    * USE OUR LOCAL CACHE - ESSENTIALLY HOW WE DO IT NOW?
        USED FOR LINKS NOW, CLIENT SECRETS ARE MANUAL
        AT LEAST THIS IS SYNCHRONOUS
    * ARE SUBSCRIPTIONS PERSISTED AT THE CLIENT LEVEL?
    * QUERY THE DB DIRECTLY?
        THE PLUS SIDE OF THIS IS IT CAN BE DONE SYNCHRONOUSLY (I THINK)
        THE DOWN SIDE IS IT'S SOMETHING ELSE WITH DB ACCESS (SECURITY)
        BUT IT'S PROBABLY BETTER THAN SENDING CREDENTIALS OVER MQTT
            THE /ctrl/add MESSAGE COULD JUST HAVE THE group name, i.e. maclawran
            AND THE CLIENT COULD GRAB THE CREDENTIALS FROM THE DB AND START THE
            LISTENER - SO MQTT IS JUST LIKE 'hey - you've got a new client!'
    * SEND A MESSAGE TO THE CONTROL CHANNEL /ctrl/cmd -> GETCLIENTS
        REPLIES WITH A /ctrl/add MESSAGE WITH EVERYTHING TO ADD
    * THERE'S A POTENTIAL ISSUE IF WE GET MESSAGES BEFORE WE KNOW HOW TO HANDLE THEM
        I.E. WE DON'T HAVE THE LINKS SO DON'T KNOW WHO TO PASS THEM ALONG TO

COULD IT MAKE SENSE TO HAVE /control BE A SEPARATE PROGRAM ENTIRELY?



DISCUSSION
----------
https://dev.maclawran.ca/auth -> ADD TO SLACK BUTTON (via add2slack.js) -> 
https://dev.maclawran.ca/auth/redirect -> ADDS THE domain, team and token to the DB
AND SENDS AN MESSAGE TO ADD A BOT TO mirror-bot.js VIA /cmd/add domain

TESTING IS CORRECT BUT COUNTER-INTUITIVE
* node mqtt-test.js /ripcitysoftware.slack.com/messages/CEUDECU0Z  "hello world2"
* Posts to /ripcitysoftware.slack.com/messages/CEUDECU0Z ARE GOING TO MAC
* THIS IS BECAUSE mac SUBSCRIBES TO MESSAGES FROM RIPCITY

What sort of input do we need?

- Invite the bot to a channel
    https://maclawran.slack.com/

- tell NSA to link to a remote channel
    @nsa link https://other.slack.com/GROUPID
    links the CURRENT CHANNEL TO THE REMOTE CHANNEL, i.e.
    /maclawran/messages/general <-> /ripcity/messages/general
    STARTS PUBLISHING IMMEDIATELY TO IT'S OWN CHANNEL
    SUBSCRIBES IMMEDIATELY TO THE REMOTE CHANNEL
    ALL THE OTHER SIDE NEEDS TO DO IS INSTALL THE APP

- tell NSA to unlink a remote channel
  @nsa unlink channel

PERMISSIONS
    WE'RE USING THE SLACK CHANNEL ID AS A SHARED SECRET
    THIS COULD BE BETTER

LIMITS
    TEST - CAN WE LINK ONE CHANNEL TO SEVERAL OUTBOUND?

    @nsa link URL
    @nsa unlink URL
    @nsa show-links


